<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Sari-Sari Store</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body {background:#f8f9fa;}
.checkout-container {display:flex; flex-wrap:wrap; gap:20px;}
.left, .right {background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.left {flex:1; min-width:300px;}
.right {width:320px;}
.card-summary h5 {font-weight:600;}
.total {font-size:1.2rem; font-weight:700;}
.qr-container {text-align:center; margin-top:20px;}
</style>
</head>
<body>
<div class="container py-4">
  <h2 class="mb-4 text-center">Checkout</h2>
  <div class="checkout-container">
    
    <!-- LEFT: Customer & Payment -->
    <div class="left">
      <form id="checkout-form">
        <h5>Contact Information</h5>
        <input class="form-control mb-2" placeholder="Name" id="name" required>
        <input type="email" class="form-control mb-2" placeholder="Email Address" id="email_id" required>
        <input class="form-control mb-2" placeholder="Room Number" id="room" required>
        <input class="form-control mb-2" placeholder="Mobile Number" id="mobile" required>
        <input class="form-control mb-2" placeholder="Facebook Account" id="facebook">
        
        <h5 class="mt-3">Payment Method</h5>
        <select class="form-select mb-3" id="payment-method">
          <option value="COD">Cash on Delivery (COD)</option>
          <option value="Bank">Bank Transfer</option>
        </select>

        <button class="btn btn-primary w-100 mb-3">Complete Order</button>
      </form>
      
      <div class="qr-container" id="qrcode"></div>
    </div>

    <!-- RIGHT: Cart Summary -->
    <div class="right">
      <h5 class="card-summary">Your Order</h5>
      <div id="cart-items" class="mb-3"></div>
      <div class="d-flex justify-content-between"><span>Subtotal</span><span id="subtotal">₱0.00</span></div>
      <div class="d-flex justify-content-between"><span>Shipping</span><span id="shipping">₱0.00</span></div>
      <div class="d-flex justify-content-between"><span>Taxes</span><span id="taxes">₱0.00</span></div>
      <hr>
      <div class="d-flex justify-content-between total"><span>Total</span><span id="total">₱0.00</span></div>
      <div class="text-success mt-1" id="total-savings"></div>
    </div>

  </div>
</div>

<script>
// ==============================
// Checkout Script - Sync to Google Sheets
// ==============================

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzojLcjhR3AqqZNtRgMZdzyP5IIQvwzxeX5p0yXTuI_TTfe4E7T7AVTsQ4p8QT-fmElmw/exec"; // <-- Replace with your Apps Script URL

// Load cart from localStorage
let cart = JSON.parse(localStorage.getItem("cart")) || [];
console.log("Checkout Cart JSON:", cart); // verify JSON

// Render cart summary (unchanged)
function renderCartSummary() {
  const cartEl = document.getElementById("cart-items");
  cartEl.innerHTML = "";
  let subtotal = 0;
  let savings = 0;
  let shippingCost = 0;
  let taxes = 0;

  cart.forEach(item => {
    let price = item.price;
    let discountAmount = 0;
    if(item.discount){
      discountAmount = item.discount.includes("%") 
        ? price * parseFloat(item.discount)/100 
        : parseFloat(item.discount);
      price -= discountAmount;
      savings += discountAmount * item.qty;
    }
    subtotal += price * item.qty;

    const imgSrc = item.image_url && item.image_url.trim() !== "" 
      ? item.image_url 
      : 'https://dummyimage.com/50x50/cccccc/ffffff.png&text=No+Image';

    cartEl.innerHTML += `
      <div class="d-flex mb-2 align-items-center">
        <img src="${imgSrc}" width="50" class="me-2" 
             onerror="this.onerror=null; this.src='https://dummyimage.com/50x50/cccccc/ffffff.png&text=No+Image'">
        <div class="flex-grow-1">
          ${item.product_name}<br>
          <small>${item.qty} × ${price.toFixed(2)}</small>
        </div>
        <div>${(price*item.qty).toFixed(2)}</div>
      </div>
    `;
  });

  const total = subtotal + shippingCost + taxes;
  document.getElementById("subtotal").innerText = subtotal.toFixed(2);
  document.getElementById("shipping").innerText = shippingCost.toFixed(2);
  document.getElementById("taxes").innerText = taxes.toFixed(2);
  document.getElementById("total").innerText = total.toFixed(2);
  document.getElementById("total-savings").innerText = savings > 0 ? `TOTAL SAVINGS ${savings.toFixed(2)}` : "";
}

// Initial render
renderCartSummary();

// Handle checkout form submission
document.getElementById("checkout-form").addEventListener("submit", function(e){
  e.preventDefault();
  if(cart.length === 0){ 
    alert("Cart empty!"); 
    return; 
  }

  const subtotal = cart.reduce((sum, item) => {
    let price = item.price;
    if(item.discount){
      price = item.discount.includes("%") 
        ? price * (1 - parseFloat(item.discount)/100) 
        : price - parseFloat(item.discount);
    }
    return sum + price * item.qty;
  }, 0);

  const shippingCost = 0;
  const taxes = 0;
  const total = subtotal + shippingCost + taxes;

  const orderData = {
    action: "createOrder",       // MUST include for Apps Script
    items: cart,                 // match Apps Script expected key
    total: total,
    customer_name: document.getElementById("name").value,
    email_id: document.getElementById("email_id").value,
    room_number: document.getElementById("room").value,
    mobile: document.getElementById("mobile").value,
    facebook: document.getElementById("facebook").value,
    payment_method: document.getElementById("payment-method").value,
    shipping_cost: shippingCost,
    taxes: taxes
  };

  console.log("Submitting order to Sheets:", orderData);

  // ✅ POST to Google Sheets
  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(orderData)
  })
  .then(res => res.json())
  .then(data => {
    console.log("Order saved to Sheets:", data);

    // Save last order locally for confirmation page
    localStorage.setItem("lastOrder", JSON.stringify({ ...orderData, orderId: data.orderId }));

    // Clear cart
    localStorage.removeItem("cart");

    // Redirect to confirmation page
    window.location.href = `checkout-confirmation.html?orderId=${data.orderId}`;
  })
  .catch(err => {
    console.error("Failed to submit order:", err);
    alert("Failed to submit order. Please try again.");
  });
});
</script>
</body>
</html>